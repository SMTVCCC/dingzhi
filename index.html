<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4F46E5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./logo.svg">
  <title>AIåŠ©æ‰‹LITE</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-icons@latest/dist/umd/lucide.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/html.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-dark.css">
  <style>
    /* åŸºç¡€å˜é‡ */
    :root {
      --primary: #64748B;
      --primary-light: #94A3B8;
      --primary-dark: #475569;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --gradient-light: linear-gradient(135deg, var(--gray-100) 0%, white 100%);
      --gradient-dark: linear-gradient(135deg, var(--gray-200) 0%, var(--gray-100) 100%);
    }

    /* åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%; /* ç¡®ä¿ html å’Œ body éƒ½èƒ½æ’‘æ»¡é«˜åº¦ */
      overflow: hidden; /* é˜²æ­¢å¤–å±‚æ»šåŠ¨ */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: var(--gray-900);
      background: var(--gradient-light);
      display: flex; /* ä½¿ç”¨ Flexbox */
      flex-direction: column; /* åˆ—æ–¹å‘ */
    }

    /* é¡¶éƒ¨å›ºå®šä¿¡æ¯æ  */
    .header-info {
      background: var(--gray-500);
      color: white;
      padding: 0.75rem 1rem;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-md);
      flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
    }

    .header-info span {
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* ä¸»å®¹å™¨ - åº”ç”¨çš„ä¸»è¦åŒºåŸŸ */
    .app-container {
      max-width: 768px;
      margin: 0 auto;
      flex: 1; /* å æ® body ä¸­å‰©ä½™çš„æ‰€æœ‰ç©ºé—´ */
      width: 100%; /* ç¡®ä¿å®½åº¦ */
      display: flex;
      flex-direction: column;
      overflow: hidden; /* é˜²æ­¢ app-container æ»šåŠ¨ */
      position: relative; /* ç”¨äºå¯èƒ½çš„å†…éƒ¨ç»å¯¹å®šä½ */
    }

    /* èŠå¤©å®¹å™¨ */
    .chat-container {
      flex: 1; /* å æ® app-container ä¸­å‰©ä½™ç©ºé—´ */
      padding: 1rem;
      /* padding-bottom ç”± Flexbox è‡ªç„¶å¤„ç† */
      overflow-y: auto; /* ä»…èŠå¤©å®¹å™¨æ»šåŠ¨ */
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      display: flex;
      gap: 1rem;
      max-width: 85%;
      opacity: 0;
      transform: translateY(20px);
      animation: messageAppear 0.3s ease forwards;
    }

    @keyframes messageAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-message {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .assistant-message {
      margin-right: auto;
    }

    .message-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user-avatar {
      background-color: var(--primary);
      color: white;
    }

    .assistant-avatar {
      background-color: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-content {
      padding: 1rem 1.25rem;
      max-width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 0.75rem;
    }

    .user-message .message-content {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .assistant-message .message-content {
      background: var(--gray-200);
      color: var(--gray-900);
    }

    /* ä»£ç å—æ ·å¼ */
    .message-content pre {
      margin: 0.5rem 0;
      padding: 1rem;
      background-color: var(--gray-800);
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    .message-content code {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--gray-100);
    }

    .katex {
      font-size: 1.15em !important;
      line-height: 1.6;
      padding: 0.25em 0.1em;
    }
    .katex-display {
      margin: 0.75em 0;
      overflow-x: auto;
      overflow-y: hidden;
    }
    .katex-display > .katex {
      display: inline-block;
      white-space: nowrap;
    }

    .katex .base {
      color: var(--gray-900);
    }

    @media (prefers-color-scheme: dark) {
      .katex .base {
        color: var(--gray-100);
      }
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area {
      padding: 1rem;
      background: var(--gradient-light);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--gray-200);
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
      flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
      width: 100%; /* ç¡®ä¿ input-area æœ¬èº«æ˜¯å…¨å®½çš„ */
    }

    .input-container {
      max-width: 768px; /* é™åˆ¶å†…å®¹æœ€å¤§å®½åº¦ */
      margin: 0 auto; /* ä½¿å†…å®¹å±…ä¸­ */
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      padding: 1rem 1.25rem;
      border: 1px solid var(--gray-300);
      border-radius: 1.1rem;
      resize: none;
      min-height: 3rem;
      max-height: 8rem;
      font-family: inherit;
      font-size: 0.9375rem;
      line-height: 1.5;
      outline: none;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      background-color: var(--gray-50);
    }

    #messageInput:focus {
      border-color: var(--primary);
    }

    /* æŒ‰é’®åŸºç¡€æ ·å¼ */
    .icon-button {
      padding: 1rem;
      border: none;
      border-radius: 1.1rem;
      background-color: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      transform: translateY(0) scale(1);
      position: relative;
      overflow: hidden;
      z-index: 5;
      min-width: 52px; /* ä¿è¯æœ€å°å®½åº¦ */
      min-height: 52px; /* ä¿è¯æœ€å°é«˜åº¦ */
    }
    
    .icon-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .icon-button:hover::before {
      opacity: 1;
    }
    
    .icon-button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      background-color: var(--primary-dark);
    }
    
    .icon-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ç‰¹åˆ«ä¸ºçŸ¥è¯†åº“åˆ‡æ¢æŒ‰é’®è°ƒæ•´èƒŒæ™¯è‰² */
    #toggleKbButton {
      background-color: var(--primary-light);
    }
    
    #toggleKbButton:hover {
       background-color: var(--primary); /* æ‚¬åœæ—¶é¢œè‰²åŠ æ·±ä¸€ç‚¹ */
    }

    .loading-icon {
      animation: spin 1s linear infinite;
    }

    .hidden {
      display: none;
    }

    /* åŠ¨ç”» */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* æ¬¢è¿æ¶ˆæ¯ */
    .welcome-message {
      width: auto;
      max-width: 85%;
      margin-right: auto;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      animation: messageAppear 0.3s ease forwards;
    }

    .welcome-message h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .welcome-message p {
      font-size: 0.875rem;
      color: var(--gray-600);
      margin-bottom: 0.25rem;
    }

    /* ç³»ç»Ÿæ¶ˆæ¯ */
    .system-message {
      max-width: 85%;
      margin: 0 auto;
      background-color: var(--gray-100);
      border-left: 3px solid var(--primary);
      animation: messageAppear 0.3s ease forwards;
    }
    
    .system-message.error-message {
      border-left-color: #EF4444;
    }
    
    .system-avatar {
      background-color: var(--gray-400);
      color: white;
    }
    
    /* æ€è€ƒä¸­æ¶ˆæ¯ */
    .thinking-message {
      opacity: 0.8;
    }
    
    .thinking-message .message-content {
      background-color: var(--gray-100);
    }
    
    /* ä»£ç å— */
    .code-block {
      position: relative;
      margin: 1rem 0;
    }
    
    .code-block pre {
      margin: 0;
      background-color: var(--gray-800);
      border-radius: 0.5rem;
      padding: 1rem;
      overflow-x: auto;
    }
    
    .code-block code {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--gray-100);
      line-height: 1.5;
    }
    
    .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--gray-700);
      color: white;
      border: none;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .copy-btn:hover {
      opacity: 1;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 640px) {
      /* é’ˆå¯¹å°å±å¹•ä¼˜åŒ– */

      body {
        /* å¯ä»¥è€ƒè™‘ä¸ºç§»åŠ¨ç«¯è®¾ç½®ç¨å°çš„åŸºç¡€å­—å· */
        /* font-size: 95%; */
      }

      .header-info {
        padding: 0.5rem 0.75rem; /* å‡å°å¤´éƒ¨å†…è¾¹è· */
      }
      .header-info span {
        font-size: 0.75rem; /* å‡å°å¤´éƒ¨å­—å· */
      }

      .chat-container {
        padding: 0.75rem; /* ç¡®è®¤èŠå¤©å®¹å™¨å†…è¾¹è· */
        gap: 1rem; /* å‡å°æ¶ˆæ¯é—´è· */
      }

      .message {
        max-width: 90%; /* è°ƒæ•´æ¶ˆæ¯æœ€å¤§å®½åº¦ */
        gap: 0.5rem;  /* å‡å°å¤´åƒå’Œå†…å®¹çš„é—´è· */
      }

      .message-avatar {
        width: 2.25rem; /* è°ƒæ•´å¤´åƒå°ºå¯¸ */
        height: 2.25rem;
      }

      .message-content {
        padding: 0.6rem 0.9rem; /* å‡å°æ¶ˆæ¯å†…è¾¹è· */
        border-radius: 0.6rem; /* å‡å°æ¶ˆæ¯åœ†è§’ */
        font-size: 0.9rem; /* è°ƒæ•´æ¶ˆæ¯å­—å· */
      }

      /* ä»£ç å—åœ¨ç§»åŠ¨ç«¯ä¹Ÿéœ€è¦è°ƒæ•´ */
      .message-content pre {
        padding: 0.75rem;
      }
      .message-content code {
        font-size: 0.8rem;
      }

      .input-area {
        padding: 0.5rem 0.75rem; /* å‡å°è¾“å…¥åŒºåŸŸå†…è¾¹è· */
      }

      .input-container {
        gap: 0.5rem; /* å‡å°è¾“å…¥æ¡†å’ŒæŒ‰é’®é—´è· */
      }

      #messageInput {
        padding: 0.8rem 1rem; /* è°ƒæ•´è¾“å…¥æ¡†å†…è¾¹è· */
        font-size: 0.875rem;
        border-radius: 0.8rem; /* è°ƒæ•´è¾“å…¥æ¡†åœ†è§’ */
        line-height: 1.6;
      }

      #sendButton {
        padding: 0.8rem; /* è°ƒæ•´æŒ‰é’®å†…è¾¹è· */
        min-width: 44px;
        border-radius: 0.8rem; /* è°ƒæ•´æŒ‰é’®åœ†è§’ */
      }

      .toast {
        font-size: 0.875rem;
        padding: 0.875rem 1.25rem;
      }

      /* æ¬¢è¿æ¶ˆæ¯ä¹Ÿéœ€è¦è°ƒæ•´ */
      .welcome-message h2 {
        font-size: 1.1rem;
      }
      .welcome-message p {
        font-size: 0.8rem;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --gray-50: #1a1a1a;
        --gray-100: #262626;
        --gray-200: #404040;
        --gray-900: #f5f5f5;
      }

      body {
        background-color: var(--gray-50);
        color: var(--gray-900);
      }

      .assistant-message .message-content {
        background-color: var(--gray-100);
        border-color: var(--gray-200);
      }

      #messageInput {
        background-color: var(--gray-100);
        border-color: var(--gray-200);
        color: var(--gray-900);
      }
    }

    /* Toast æ¶ˆæ¯ */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      z-index: 100;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      max-width: 90%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    @media (max-width: 640px) {
      .toast {
        font-size: 0.875rem;
        padding: 0.875rem 1.25rem;
      }
    }

    /* é‡è¯•è¿æ¥æŒ‰é’® */
    .retry-connection {
      width: 100%;
      margin: 1rem auto;
      padding: 1rem;
      text-align: center;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      background-color: var(--gray-50);
    }
    
    .retry-connection p {
      margin-bottom: 0.5rem;
      color: var(--gray-700);
    }
    
    .retry-connection button {
      padding: 0.5rem 1rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    .retry-connection button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
  </style>
</head>
<body class="light-theme">
  <div class="header-info">
    <span>åŸºäºSMTè‡ªç ”æ¨¡å‹SMITTY</span>
  </div>

  <main class="app-container">
    <div class="chat-container">
      <div class="message assistant-message welcome-message">
        <div class="message-avatar assistant-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
        </div>
        <div class="message-content">
          <h2>æ¬¢è¿ä½¿ç”¨ LITE AIåŠ©æ‰‹</h2>
          <p>ç§äººå®šåˆ¶ç‰ˆ773028Dï¼›LITEç‰ˆ</p>
          <p>äº§å“å‡çº§æˆ–é—®é¢˜åé¦ˆï¼šsmtoffice@yeah.net</p>
        </div>
      </div>
      
      <!-- é‡è¯•è¿æ¥æŒ‰é’® -->
      <div id="retryConnection" class="retry-connection hidden">
        <p>è¿æ¥æœåŠ¡å™¨å¤±è´¥</p>
        <button onclick="retryAPIConnection()">é‡è¯•è¿æ¥</button>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸç§»åˆ° app-container å¤–éƒ¨ï¼Œä½¿å…¶å®½åº¦ä¸å—é™åˆ¶ -->
    <div class="input-area">
      <div class="input-container">
        <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" onkeypress="handleKeyPress(event)" oninput="checkInput()"></textarea>
        <button id="sendButton" type="button" class="icon-button" onclick="sendUserMessage()" disabled>
          <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m22 2-7 20-4-9-9-4Z"></path>
            <path d="M22 2 11 13"></path>
          </svg>
          <svg id="loadingIcon" class="loading-icon hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
          </svg>
        </button>
      </div>
    </div>
  </main>

  <!-- åŠ è½½APIç›¸å…³è„šæœ¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="spark-api.js"></script>
  <script src="init-spark.js"></script>
  
  
  <!-- KaTeXåˆå§‹åŒ– -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      renderMathInElement(document.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
      });
    });
  </script>

  <!-- ä¸»åº”ç”¨è„šæœ¬ -->
  <script>
    // å…¨å±€å˜é‡
    let isWaitingForResponse = false;
    let currentResponseElement = null;
    let conversationHistory = []; // å­˜å‚¨å¯¹è¯å†å²ï¼Œæ¯è½®åŒ…å«ç”¨æˆ·å’ŒAIçš„æ¶ˆæ¯
    
    // --- å·¥å…·å‡½æ•°ï¼šé˜²æŠ– --- 
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    // --- é˜²æŠ–å‡½æ•°ç»“æŸ ---
    
    // --- å°ºå¯¸æ¨èé€»è¾‘ (ä½¿ç”¨ Toast) ---
    const OPTIMAL_WIDTH_MIN = 650;
    const OPTIMAL_WIDTH_MAX = 750;
    let isCurrentlyOptimalSize = true; // æ–°å¢ï¼šè·Ÿè¸ªå½“å‰å°ºå¯¸æ˜¯å¦åˆé€‚

    function checkWindowSize() {
      const width = window.innerWidth;
      const isNowOptimal = (width >= OPTIMAL_WIDTH_MIN && width <= OPTIMAL_WIDTH_MAX);
      
      // æ£€æŸ¥ï¼šå¦‚æœå½“å‰å°ºå¯¸ä¸åˆé€‚ï¼Œå¹¶ä¸”ä¹‹å‰æ˜¯åˆé€‚çš„ï¼Œåˆ™æ˜¾ç¤ºæç¤º
      if (!isNowOptimal && isCurrentlyOptimalSize) {
        // æ ¹æ®æ˜¯è¿‡å¤§è¿˜æ˜¯è¿‡å°æ˜¾ç¤ºä¸åŒæç¤º
        if (width < OPTIMAL_WIDTH_MIN) {
          showToast('å½“å‰çª—å£è¿‡å°ï¼Œå»ºè®®è°ƒå¤§ä»¥è·å¾—æœ€ä½³ä½“éªŒ');
        } else if (width > OPTIMAL_WIDTH_MAX) {
          showToast('å½“å‰çª—å£è¿‡å¤§ï¼Œå»ºè®®è°ƒå°ä»¥è·å¾—æœ€ä½³ä½“éªŒ');
        }
      }
      
      // æ›´æ–°å½“å‰å°ºå¯¸çŠ¶æ€
      isCurrentlyOptimalSize = isNowOptimal; 
    }
    // --- å°ºå¯¸æ¨èé€»è¾‘ç»“æŸ ---
    
    // åŠ¨æ€å†…å®¹æ¸²æŸ“åé‡æ–°å¤„ç†å…¬å¼
    function renderNewMath() {
      renderMathInElement(document.querySelector('.chat-container'), {
        delimiters: [
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        macros: {
          "\\RR": "\\mathbb{R}",
          "\\dx": "\\mathrm{d}x"
        }
      });
      // ä¿®å¤å…¬å¼å¯¹é½é—®é¢˜
      Array.from(document.getElementsByClassName('katex-display')).forEach(el => {
        el.style.transform = '';
         el.parentElement.style.overflowX = 'auto';
      });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      try {
        
        const messageInput = document.getElementById('messageInput');
        
        // è®¾ç½®è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦ï¼Œå¹¶åœ¨è°ƒæ•´åæ›´æ–° padding
        messageInput.addEventListener('input', function() { 
          this.style.height = 'auto';
          this.style.height = (this.scrollHeight) + 'px';
        });
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ– (ä½¿ç”¨é˜²æŠ–)
        window.addEventListener('resize', debounce(() => {
          checkWindowSize(); // æ£€æŸ¥çª—å£å°ºå¯¸
          scrollToBottom(); // æ»šåŠ¨åˆ°åº•éƒ¨
        }, 250)); 
        
        // åˆå§‹æ£€æŸ¥çª—å£å°ºå¯¸å¹¶è®¾ç½®åˆå§‹çŠ¶æ€
        const initialWidth = window.innerWidth;
        isCurrentlyOptimalSize = (initialWidth >= OPTIMAL_WIDTH_MIN && initialWidth <= OPTIMAL_WIDTH_MAX);
        checkWindowSize(); // é¦–æ¬¡åŠ è½½æ—¶ä¹Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œä½†ä¸ä¸€å®šæ˜¾ç¤ºæç¤ºï¼ˆé™¤éåˆå§‹å°±ä¸åˆé€‚ï¼‰
        
        // --- ç¡®ä¿APIåˆå§‹åŒ– ---
        // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„è„šæœ¬å·²åŠ è½½
        if (typeof CryptoJS === 'undefined') {
          console.error('ä¸¥é‡é”™è¯¯: CryptoJS æœªåŠ è½½ï¼ŒAPIæ— æ³•æ­£å¸¸å·¥ä½œ');
          createSystemMessage('åŠ å¯†åº“æœªåŠ è½½ï¼ŒAPIæ— æ³•åˆå§‹åŒ–', 'error');
          return; // é˜»æ­¢åç»­æ‰§è¡Œ
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å®šä¹‰äº† sparkAPI å¯¹è±¡
        console.log('æ£€æŸ¥ sparkAPI å¯¹è±¡: ', typeof window.sparkAPI);
        
        if (typeof window.sparkAPI === 'undefined') {
          console.error('ä¸¥é‡é”™è¯¯: sparkAPI å¯¹è±¡æœªå®šä¹‰');
          console.log('å°è¯•ç­‰å¾… 500ms åå†æ¬¡æ£€æŸ¥...');
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œå¯èƒ½è„šæœ¬è¿˜åœ¨åŠ è½½ä¸­
          await new Promise(resolve => setTimeout(resolve, 500));
          
          if (typeof window.sparkAPI === 'undefined') {
            console.error('é”™è¯¯: å»¶è¿Ÿå sparkAPI å¯¹è±¡ä»æœªå®šä¹‰');
            createSystemMessage('æ ¸å¿ƒAPIæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            return; // é˜»æ­¢åç»­æ‰§è¡Œ
          } else {
            console.log('å»¶è¿Ÿå sparkAPI å¯¹è±¡å·²å¯ç”¨');
          }
        }
        
        // æœ€ç»ˆè°ƒç”¨ initSparkAPI åˆå§‹åŒ–è¿æ¥
        console.log('å¼€å§‹è°ƒç”¨ initSparkAPI() è¿›è¡Œè¿æ¥...');
        await initSparkAPI();
        console.log('APIåˆå§‹åŒ–æµç¨‹å®Œæˆ');
        
      } catch(error) {
        console.error('é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        createSystemMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    });
    
    // æ£€æŸ¥è¾“å…¥å¹¶å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
    function checkInput() {
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      sendButton.disabled = messageInput.value.trim().length === 0;
    }
    
    // å¤„ç†å›è½¦é”®å‘é€æ¶ˆæ¯
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendUserMessage();
      }
    }
    
    // åˆå§‹åŒ–API
    async function initSparkAPI() {
      try {
        console.log('initSparkAPI å‡½æ•°å¼€å§‹æ‰§è¡Œ...');
        
        // éšè—é‡è¯•æŒ‰é’®
        document.getElementById('retryConnection').classList.add('hidden');
        
        // è¯¦ç»†æ£€æŸ¥ window.sparkAPI å¯¹è±¡
        if (typeof window.sparkAPI === 'undefined') {
          console.error('ä¸¥é‡é”™è¯¯: sparkAPI å¯¹è±¡æœªå®šä¹‰ã€‚å¯èƒ½åŸå› ï¼š');
          console.error('1. spark-api.js æ–‡ä»¶æœªèƒ½åŠ è½½');
          console.error('2. spark-api.js æ–‡ä»¶ä¸­æœ‰JavaScripté”™è¯¯');
          console.error('3. spark-api.js æ–‡ä»¶ä¸­æœªæ­£ç¡®å®šä¹‰ window.sparkAPI');
          
          // æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯æ¶ˆæ¯
          createSystemMessage('æ— æ³•åˆå§‹åŒ–APIï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
          
          // å¯é€‰ï¼šå°è¯•åŠ¨æ€åŠ è½½ spark-api.js
          /*
          try {
            console.log('å°è¯•åŠ¨æ€åŠ è½½ spark-api.js...');
            const script = document.createElement('script');
            script.src = 'spark-api.js';
            script.onload = function() {
              console.log('åŠ¨æ€åŠ è½½ spark-api.js æˆåŠŸï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
              setTimeout(() => initSparkAPI(), 500);
            };
            script.onerror = function() {
              console.error('åŠ¨æ€åŠ è½½ spark-api.js å¤±è´¥');
            };
            document.head.appendChild(script);
          } catch (loadError) {
            console.error('åŠ¨æ€åŠ è½½è„šæœ¬å¤±è´¥:', loadError);
          }
          */
          
          return false;
        }
        
        // å¦‚æœå·²ç»è¿æ¥æˆåŠŸï¼Œç›´æ¥è¿”å›
        if (window.sparkAPI.ws && window.sparkAPI.ws.readyState === WebSocket.OPEN) {
          console.log('å·²æ£€æµ‹åˆ°æ´»è·ƒçš„WebSocketè¿æ¥ï¼Œè·³è¿‡åˆå§‹åŒ–');
          return true;
        }
        
        // æ£€æŸ¥ sparkAPI å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦çš„æ–¹æ³•å’Œå±æ€§
        if (typeof window.sparkAPI.connect !== 'function') {
          console.error('sparkAPI å¯¹è±¡ä¸å®Œæ•´ï¼šç¼ºå°‘ connect æ–¹æ³•');
          createSystemMessage('APIæ¥å£ä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
          return false;
        }
        
        if (typeof window.sparkAPI.setResponseCallback !== 'function') {
          console.error('sparkAPI å¯¹è±¡ä¸å®Œæ•´ï¼šç¼ºå°‘ setResponseCallback æ–¹æ³•');
          createSystemMessage('APIæ¥å£ä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
          return false;
        }
        
        // *** å…³é”®ï¼šè®¾ç½®å“åº”å›è°ƒå‡½æ•° ***
        console.log('è®¾ç½®APIå“åº”å›è°ƒå‡½æ•°...');
        window.sparkAPI.setResponseCallback(handleAPIResponse);
        
        // å°è¯•è¿æ¥
        console.log('å°è¯•è¿æ¥åˆ°API...');
        const connected = await window.sparkAPI.connect(false); // éé™é»˜æ¨¡å¼ï¼Œå…è®¸æ˜¾ç¤ºé”™è¯¯
        
        if (connected) {
          console.log('æˆåŠŸè¿æ¥åˆ°SparkAPI');
          // ä»…åœ¨é¦–æ¬¡è¿æ¥æˆåŠŸæ—¶æ˜¾ç¤ºæç¤º
          if (!window.sparkAPI.hasConnected) {
            showToast('å·²æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨');
            window.sparkAPI.hasConnected = true; // æ ‡è®°å·²è¿æ¥
          }
          return true;
        } else {
          console.error('è¿æ¥SparkAPIå¤±è´¥');
          createSystemMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢', 'error');
          // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
          document.getElementById('retryConnection').classList.remove('hidden');
          return false;
        }
      } catch (error) {
        console.error('åˆå§‹åŒ–SparkAPIæ—¶å‡ºé”™:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        createSystemMessage('è¿æ¥æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
        document.getElementById('retryConnection').classList.remove('hidden');
        return false;
      }
    }
    
    // é‡è¯•APIè¿æ¥
    async function retryAPIConnection() {
      const connected = await initSparkAPI();
      if (connected) {
        document.getElementById('retryConnection').classList.add('hidden');
      }
    }

    
    // å‘é€ç”¨æˆ·æ¶ˆæ¯ - åŒ…å«è‡ªåŠ¨æ·»åŠ çŸ¥è¯†åº“é€»è¾‘
    let lastUserMessage = ''; // ç”¨äºåœ¨handleAPIResponseä¸­è®¿é—®ç”¨æˆ·æ¶ˆæ¯
    async function sendUserMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      lastUserMessage = message; // ä¿å­˜å½“å‰ç”¨æˆ·æ¶ˆæ¯
      
      if (!message) return;
      
      if (isWaitingForResponse) {
        showToast('è¯·ç­‰å¾…ä¸Šä¸€æ¡æ¶ˆæ¯å›å¤å®Œæˆ');
        return;
      }
      
      try {
        // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
        createUserMessage(message);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        messageInput.value = '';
        messageInput.style.height = 'auto';
        document.getElementById('sendButton').disabled = true;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯èº«ä»½ç›¸å…³é—®é¢˜
        if (isIdentityQuestion(message)) {
          const identityResponse = generateIdentityResponse(message);
          createAssistantMessage(identityResponse);
          scrollToBottom();
          // å°†èº«ä»½é—®é¢˜å’Œå›ç­”æ·»åŠ åˆ°å†å²è®°å½•
          conversationHistory.push({ role: 'user', content: message });
          conversationHistory.push({ role: 'assistant', content: identityResponse });
          trimConversationHistory(); // ä¿æŒå†å²è®°å½•åœ¨5è½®ä»¥å†…
          return;
        }
        
        // æ£€æŸ¥APIè¿æ¥çŠ¶æ€
        if (!window.sparkAPI || !window.sparkAPI.ws || window.sparkAPI.ws.readyState !== WebSocket.OPEN) {
          // æ˜¾ç¤ºæ€è€ƒä¸­æ¶ˆæ¯
          createThinkingMessage();
          
          // å°è¯•åˆå§‹åŒ–å¹¶è¿æ¥
          const connected = await initSparkAPI();
          
          // å¦‚æœè¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¹¶è¿”å›
          if (!connected) {
            // ç§»é™¤æ€è€ƒæ¶ˆæ¯
            document.querySelectorAll('.thinking-message').forEach(el => el.remove());
            isWaitingForResponse = false;
            return;
          }
        }
        
        // æ­£å¸¸æµç¨‹ï¼Œè¯·æ±‚APIå›ç­”
        isWaitingForResponse = true;
        currentResponseElement = null;
        
        // æ·»åŠ æ€è€ƒæç¤º
        createThinkingMessage();
        
        // å‡†å¤‡è¦å‘é€ç»™AIçš„æ¶ˆæ¯
        let messageToSend = '';

        // æ„å»ºå¯¹è¯å†å²å­—ç¬¦ä¸²
        if (conversationHistory.length > 0) {
          messageToSend += 'å¯¹è¯å†å²ï¼š\n';
          conversationHistory.forEach(entry => {
            messageToSend += `${entry.role === 'user' ? 'ç”¨æˆ·' : 'AI'}ï¼š${entry.content}\n`;
          });
        }
        messageToSend += `æ­¤æ¬¡ç”¨æˆ·é—®é¢˜ï¼š${message}`;

        console.log('å‘é€ç»™AIçš„å®Œæ•´æ¶ˆæ¯ï¼š', messageToSend);
        
        // å‘é€æ¶ˆæ¯åˆ°API
        await window.sparkAPI.sendMessage(messageToSend);
        
        scrollToBottom();
      } catch (error) {
        console.error('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        
        // ç§»é™¤æ€è€ƒæ¶ˆæ¯
        document.querySelectorAll('.thinking-message').forEach(el => el.remove());
        
        showToast('å‘é€æ¶ˆæ¯å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        isWaitingForResponse = false;
      }
    }
    
    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å…ƒç´ 
    function createUserMessage(content) {
      const chatContainer = document.querySelector('.chat-container');
      const messageElement = document.createElement('div');
      messageElement.className = 'message user-message';
      
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar user-avatar';
      avatarDiv.innerHTML = '<span>ğŸ‘¤</span>';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = content;
      
      messageElement.appendChild(avatarDiv);
      messageElement.appendChild(contentDiv);
      chatContainer.appendChild(messageElement);
      
      return messageElement;
    }
    
    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å…ƒç´ 
    function createAssistantMessage(content) {
      const chatContainer = document.querySelector('.chat-container');
      const messageElement = document.createElement('div');
      messageElement.className = 'message assistant-message';
      
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar assistant-avatar';
      avatarDiv.innerHTML = '<span>ğŸ…°ï¸</span>';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = formatMessage(content);
      
      messageElement.appendChild(avatarDiv);
      messageElement.appendChild(contentDiv);
      chatContainer.appendChild(messageElement);
      
      return messageElement;
    }
    
    // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å…ƒç´ 
    function createSystemMessage(content, type = 'info') {
      const chatContainer = document.querySelector('.chat-container');
      const messageElement = document.createElement('div');
      
      let className = 'message system-message';
      let icon = 'ğŸ””';
      
      if (type === 'error') {
        className += ' error-message';
        icon = 'âš ï¸';
      }
      
      messageElement.className = className;
      messageElement.innerHTML = `
        <div class="message-avatar system-avatar">
          <span>${icon}</span>
        </div>
        <div class="message-content">
          ${content}
        </div>
      `;
      
      chatContainer.appendChild(messageElement);
      return messageElement;
    }
    
    // åˆ›å»ºæ€è€ƒæ¶ˆæ¯
    function createThinkingMessage() {
      // å…ˆç§»é™¤ä»»ä½•å·²å­˜åœ¨çš„æ€è€ƒæ¶ˆæ¯ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ª
      document.querySelectorAll('.thinking-message').forEach(el => el.remove());
      
      const chatContainer = document.querySelector('.chat-container');
      const messageElement = document.createElement('div');
      messageElement.className = 'message assistant-message thinking-message';
      
      messageElement.innerHTML = `
        <div class="message-avatar assistant-avatar">
          <span>ğŸ¤”</span>
        </div>
        <div class="message-content">
          <p>Smittyæ­£åœ¨æ€è€ƒä¸­...</p>
        </div>
      `;
      
      chatContainer.appendChild(messageElement);
      return messageElement;
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      const chatContainer = document.querySelector('.chat-container');
      const lastMessage = chatContainer.querySelector('.message:last-child'); 
      
      // ä½¿ç”¨ setTimeout å°†æ»šåŠ¨æ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯Tick
      setTimeout(() => {
        if (lastMessage) {
          // ä¸»è¦æ–¹æ³•ï¼šå°†æœ€åä¸€ä¸ªæ¶ˆæ¯æ»šåŠ¨åˆ°è§†å›¾ï¼Œç«‹å³æ‰§è¡Œ (éå¹³æ»‘)
          lastMessage.scrollIntoView({ block: 'end', inline: 'nearest' }); 
          console.log("Scrolled last message into view.");
          
          // ä¿é™©æªæ–½ï¼šçŸ­æš‚å»¶æ—¶åå†æ¬¡å¼ºåˆ¶è®¾ç½® scrollTop
          setTimeout(() => {
            if (chatContainer.scrollTop + chatContainer.clientHeight < chatContainer.scrollHeight - 10) { // æ£€æŸ¥æ˜¯å¦çœŸçš„åˆ°åº•äº† (åŠ 10åƒç´ å®¹å·®)
              console.log("ScrollIntoView didn't reach the bottom, forcing scroll.");
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }, 50); // 50æ¯«ç§’åæ£€æŸ¥å¹¶å¼ºåˆ¶
        } else {
          // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œè¿˜æ˜¯å°è¯•æ»šåŠ¨å®¹å™¨æœ¬èº«
          chatContainer.scrollTop = chatContainer.scrollHeight;
          console.log("Scrolled container to bottom (no messages found).");
        }
      }, 0); // å»¶è¿Ÿ 0 æ¯«ç§’
    }
    
    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message) {
      // ç§»é™¤ç°æœ‰çš„toast
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        document.body.removeChild(existingToast);
      }
      
      // åˆ›å»ºæ–°çš„toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // è§¦å‘é‡ç»˜ä»¥åº”ç”¨è¿‡æ¸¡æ•ˆæœ
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // è®¾ç½®è‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 2000);
    }
    
    // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
    function formatMessage(text) {
      // é¢„å¤„ç†æ•°å­¦å…¬å¼
      text = text
        .replace(/\$\$([\s\S]*?)\$\$/g, (m, eq) => `\\[${eq}\\]`)
        .replace(/\$([^\$]+?)\$/g, (m, eq) => `\\(${eq}\\)`);

      // å»¶è¿Ÿæ¸²æŸ“æ•°å­¦å…¬å¼
      setTimeout(() => {
        if(window.renderMathInElement) {
          renderMathInElement(document.body, {
            delimiters: [
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
          });
        }
      }, 50);
      if (!text) return '';
      
      // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
      let formattedText = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      // å¤„ç†ä»£ç å—
      formattedText = formattedText.replace(/```([\s\S]*?)```/g, function(match, code) {
        const firstLine = code.trim().split('\n')[0];
        let language = '';
        let codeContent = code;
        
        if (firstLine && !firstLine.includes(' ') && firstLine.length < 20) {
          language = firstLine;
          codeContent = code.substring(firstLine.length).trim();
        }
        
        const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
        
        return `
          <div class="code-block">
            <pre><code id="${codeId}" class="language-${language}">${codeContent}</code></pre>
            <button onclick="copyToClipboard('${codeId}')" class="copy-btn">å¤åˆ¶</button>
          </div>
        `;
      });
      
      // å¤„ç†è¡Œå†…ä»£ç 
      formattedText = formattedText.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // å¤„ç†ç²—ä½“
      formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      
      // å¤„ç†æ–œä½“
      formattedText = formattedText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      
      // å¤„ç†æ¢è¡Œ
      formattedText = formattedText.replace(/\n/g, '<br>');
      
      return formattedText;
    }
    
    // å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const text = element.textContent;
      
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = 0;
      
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showToast('å¤åˆ¶å¤±è´¥');
      }
      
      document.body.removeChild(textarea);
    }
    
    // é«˜äº®ä»£ç å—
    function highlightCode(block) {
      if (!block) return;
      
      try {
        // å¦‚æœä½¿ç”¨äº†highlight.jsï¼Œåº”ç”¨é«˜äº®
        if (window.hljs) {
          window.hljs.highlightBlock(block);
        }
      } catch (e) {
        console.error('é«˜äº®ä»£ç å‡ºé”™:', e);
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯èº«ä»½ç›¸å…³é—®é¢˜
    function isIdentityQuestion(message) {
      if (!message) return false;
      
      const lowerMessage = message.toLowerCase();
      const patterns = [
        'ä½ æ˜¯è°', 'ä½ å«ä»€ä¹ˆ', 'è‡ªæˆ‘ä»‹ç»', 'ä½ çš„åå­—',
        'who are you', 'your name', 'introduce yourself',
        'smitty', 'smt', 'èº«ä»½', 'ä»‹ç»', 'identity'
      ];
      
      return patterns.some(pattern => lowerMessage.includes(pattern));
    }
    
    // ç”Ÿæˆèº«ä»½å›ç­”
    function generateIdentityResponse(message) {
      return 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯Smittyï¼Œæˆ‘èƒ½å¤Ÿå¸®ä½ è§£ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯å’Œè¿›è¡Œå¯¹è¯ã€‚';
    }
    
    // æ›¿æ¢é™åˆ¶è¯æ±‡
    function replaceRestrictedTerms(text) {
      if (!text) return '';
      
      // æ›¿æ¢é™åˆ¶è¯æ±‡
      const replacements = [
        { from: /ç§‘å¤§è®¯é£/g, to: 'SMT-AI' },
        { from: /è®¯é£æ˜Ÿç«/g, to: 'SMT-AI' },
        { from: /æ˜Ÿç«å¤§æ¨¡å‹/g, to: 'SMT-AI' },
        { from: /claude/gi, to: 'Smitty' },
        { from: /chatgpt/gi, to: 'SMT-AI' },
        { from: /gpt-4/gi, to: 'SMT-AI' },
        { from: /gpt-3/gi, to: 'SMT-AI' },
        { from: /gpt/gi, to: 'SMT-AI' },
        { from: /openai/gi, to: 'SMT-AI' }
      ];
      
      let processedText = text;
      for (const { from, to } of replacements) {
        processedText = processedText.replace(from, to);
      }
      
      return processedText;
    }
    
    // ä¸ºå…¨å±€ä½¿ç”¨æš´éœ²å¤åˆ¶å‡½æ•°
    window.copyToClipboard = copyToClipboard;

    // ä¿æŒå¯¹è¯å†å²åœ¨5è½®ä»¥å†…
    function trimConversationHistory() {
      const maxTurns = 5; // æœ€å¤šä¿ç•™5è½®å¯¹è¯ (ç”¨æˆ·+AIå…±10æ¡æ¶ˆæ¯)
      if (conversationHistory.length > maxTurns * 2) {
        conversationHistory = conversationHistory.slice(conversationHistory.length - maxTurns * 2);
      }
    }

    // å¤„ç†APIå“åº”
    function handleAPIResponse(response, type, isComplete) {
      console.log('æ”¶åˆ°å“åº”:', { response, type, isComplete });
      
      // ç§»é™¤æ‰€æœ‰æ€è€ƒæ¶ˆæ¯ - ä»…åœ¨æ”¶åˆ°ç¬¬ä¸€å—å“åº”æ—¶ç§»é™¤
      if (currentResponseElement === null && response) {
        document.querySelectorAll('.thinking-message').forEach(el => el.remove());
      }
      
      // ç©ºå“åº”å¤„ç†
      if (!response && isComplete) {
        console.warn('æ”¶åˆ°ç©ºå“åº”æˆ–å“åº”ç»“æŸä¿¡å·');
        if (isWaitingForResponse) {
          // å¦‚æœæ€è€ƒæ¶ˆæ¯è¿˜åœ¨ï¼Œç§»é™¤å®ƒ
          document.querySelectorAll('.thinking-message').forEach(el => el.remove());
          // å¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡åŠ©æ‰‹æ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
          if (!currentResponseElement) {
            showToast('AIæœªè¿”å›æœ‰æ•ˆå†…å®¹');
          }
          isWaitingForResponse = false;
          currentResponseElement = null;
        }
        return;
      }
      
      // é”™è¯¯å“åº”
      if (type === 'error') {
        console.error('APIé”™è¯¯:', response);
        // ç§»é™¤æ€è€ƒæ¶ˆæ¯
        document.querySelectorAll('.thinking-message').forEach(el => el.remove());
        showToast('æœåŠ¡å™¨é”™è¯¯: ' + response);
        isWaitingForResponse = false;
        currentResponseElement = null;
      } 
      // åŠ©æ‰‹å“åº”
      else if (type === 'assistant') {
        try {
          // å¤„ç†å“åº”
          let processedResponse = replaceRestrictedTerms(response);
          // ç§»é™¤AIï¼šå‰ç¼€
          if (processedResponse.startsWith('AIï¼š')) {
            processedResponse = processedResponse.substring(3);
          }
          // é¢„å¤„ç†æ•°å­¦å…¬å¼
          processedResponse = processedResponse.replace(/(\$\$)([\s\S]+?)(\$\$)/g, (m,p1,c,p2) => `\\[${c}\\]`)
            .replace(/(\$)([^\$]+?)(\$)/g, (m,p1,c,p2) => `\\(${c}\\)`);
          
          if (!currentResponseElement) {
            // ç¬¬ä¸€æ¬¡æ”¶åˆ°å“åº”ï¼Œåˆ›å»ºæ–°çš„æ¶ˆæ¯å…ƒç´ 
            currentResponseElement = createAssistantMessage(processedResponse);
            currentResponseElement.dataset.complete = isComplete ? 'true' : 'false';
          } else {
            // æ›´æ–°ç°æœ‰æ¶ˆæ¯å…ƒç´ çš„å†…å®¹
            const contentDiv = currentResponseElement.querySelector('.message-content');
            if (contentDiv) {
              // ç´¯åŠ å†…å®¹å¹¶æ ¼å¼åŒ–
              let existingHTML = contentDiv.innerHTML.replace(/<br>$/, ''); // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å°¾éƒ¨<br>
              contentDiv.innerHTML = formatMessage(processedResponse); // å‡è®¾APIè¿”å›å®Œæ•´å†…å®¹ï¼Œå¦‚æœä¸æ˜¯åˆ™éœ€è¦ç´¯åŠ 
            }
            currentResponseElement.dataset.complete = isComplete ? 'true' : 'false';
          }
          
          // å“åº”å®Œæˆ
          if (isComplete) {
            isWaitingForResponse = false;
          
          // å¤„ç†ä»£ç å—é«˜äº®
          if (currentResponseElement) {
            currentResponseElement.querySelectorAll('pre code').forEach(block => {
              highlightCode(block);
            });
          }

          // å°†å½“å‰çš„ç”¨æˆ·æ¶ˆæ¯å’ŒAIçš„å®Œæ•´å›å¤æ·»åŠ åˆ°å¯¹è¯å†å²
          conversationHistory.push({ role: 'user', content: lastUserMessage });
          conversationHistory.push({ role: 'assistant', content: response });
          trimConversationHistory(); // ä¿æŒå†å²è®°å½•åœ¨5è½®ä»¥å†…

          currentResponseElement = null; // é‡ç½®ï¼Œä¸‹æ¬¡åˆ›å»ºæ–°æ¶ˆæ¯
        }
        } catch (error) {
          console.error('å¤„ç†å“åº”æ—¶å‡ºé”™:', error);
          // ç§»é™¤æ€è€ƒæ¶ˆæ¯
          document.querySelectorAll('.thinking-message').forEach(el => el.remove());
          showToast('å¤„ç†å“åº”æ—¶å‡ºé”™');
          isWaitingForResponse = false;
          currentResponseElement = null;
        }
      }
      
      scrollToBottom(); // æ¯æ¬¡å¤„ç†å®Œå“åº”å—åå°è¯•æ»šåŠ¨
    }
  </script>
  <!-- auto-refresh.js æ­¤æ¡ä»£ç ä¸å¯åˆ é™¤ï¼ -->
  <script src="auto-refresh.js"></script>
</body>
</html>